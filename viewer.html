<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Commercial Manga Viewer – Optimized</title>
<style>
/*===========================  THEME  ===========================*/
:root{
  --primary-color:#4a6cf7;
  --secondary-color:#ff6b6b;
  --background-color:#fff;
  --text-color:#333;
  --overlay-bg:rgba(0,0,0,.7);
  --overlay-text:#fff;
  --btn-bg:rgba(255,255,255,.2);
  --btn-hover:rgba(255,255,255,.35);
  --slider-track:rgba(255,255,255,.3);
  --slider-thumb:#fff;
  --spinner:#fff;
  --error:#ff4d4d;
}
@media(prefers-color-scheme:dark){
  :root{
    --background-color:#121212;
    --text-color:#f1f1f1;
    --overlay-bg:rgba(0,0,0,.8)
  }
}
/*===========================  RESET  ===========================*/
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;width:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--background-color);color:var(--text-color);overflow:hidden;user-select:none;touch-action:manipulation;position:fixed}
/*===========================  STRUCTURE  ===========================*/
#viewer{display:flex;justify-content:center;align-items:center;position:relative;height:100%;width:100%;background:#000;cursor:grab}
#viewer:active{cursor:grabbing}
#zoom{height:100%;width:100%;position:absolute;display:flex;justify-content:center;align-items:center;transform-origin:center;transform:translate3d(0,0,0);will-change:transform}
.animating{will-change:transform}
#page-wrap{position:relative;width:100%;height:100%;display:flex;justify-content:center;align-items:center;overflow:hidden}
.manga-page{max-width:100%;max-height:100%;object-fit:contain;pointer-events:none;transition:opacity .3s ease;background:transparent}
/*===========================  NAV ZONES  ===========================*/
.nav{position:absolute;top:0;height:100%;width:30%;z-index:10}
#prev-zone{left:0}
#center-zone{left:30%;width:40%}
#next-zone{right:0}
/*===========================  UI OVERLAY  ===========================*/
.overlay{position:absolute;left:0;width:100%;padding:15px;display:flex;justify-content:space-between;align-items:center;background:var(--overlay-bg);color:var(--overlay-text);z-index:20;opacity:0;transform:translateY(-100%);transition:transform .3s ease,opacity .3s ease;pointer-events:none}
.overlay>*{pointer-events:auto}
#bottom{bottom:0;top:auto;transform:translateY(100%)}
#viewer.show-ui #top,#viewer.show-ui #bottom{opacity:1;transform:translateY(0)}
/*===========================  BUTTONS  ===========================*/
.btn{background:var(--btn-bg);border:none;width:40px;height:40px;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:background .2s ease;flex-shrink:0;padding:0;color:var(--overlay-text)}
.btn:hover,.btn:active{background:var(--btn-hover)}
.btn:disabled{opacity:.5;cursor:default}
.btn svg{width:24px;height:24px;fill:currentColor}
/*===========================  SLIDER  ===========================*/
#slider-wrap{flex:1;margin:0 15px;display:flex;align-items:center}
#page-slider{width:100%;height:8px;appearance:none;background:var(--slider-track);border-radius:4px;outline:0;cursor:pointer}
#page-slider::-webkit-slider-thumb,#page-slider::-moz-range-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--slider-thumb);cursor:pointer;border:none}
/*===========================  SPINNER & ERROR  ===========================*/
#spinner{position:absolute;top:50%;left:50%;width:50px;height:50px;border:4px solid rgba(255,255,255,.3);border-top-color:var(--spinner);border-radius:50%;animation:spin 1s linear infinite;transform:translate(-50%,-50%);z-index:40;display:none}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
#error{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--error);color:#fff;padding:15px 20px;border-radius:5px;max-width:80%;text-align:center;z-index:40;display:none;box-shadow:0 4px 10px rgba(0,0,0,.3)}
#error button{margin-top:10px;padding:8px 15px;background:#fff;color:var(--error);border:none;border-radius:5px;font-weight:700;cursor:pointer}
/*===========================  EPISODE MODAL  ===========================*/
#modal{position:absolute;inset:0;background:var(--overlay-bg);display:none;justify-content:center;align-items:center;z-index:50;opacity:0;transition:opacity .3s ease}
#modal.active{display:flex;opacity:1}
.modal-box{width:80%;max-width:500px;max-height:80vh;overflow-y:auto;background:var(--background-color);color:var(--text-color);border-radius:8px;padding:20px;transform:scale(.95);opacity:0;transition:transform .3s ease,opacity .3s ease}
#modal.active .modal-box{transform:scale(1);opacity:1}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;border-bottom:1px solid rgba(128,128,128,.2);padding-bottom:10px}
.ep-item{padding:12px;background:rgba(128,128,128,.1);border-radius:5px;cursor:pointer;transition:background .2s}
.ep-item:hover{background:rgba(128,128,128,.2)}
.ep-item.current{border-left:3px solid var(--primary-color);font-weight:700;background:rgba(128,128,128,.15)}
</style>
</head>
<body>
<div id="viewer">
  <div id="zoom" class="animating">
    <div id="page-wrap"><img id="page" class="manga-page" alt="manga" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" /></div>
  </div>
  <div class="nav" id="prev-zone"></div>
  <div class="nav" id="center-zone"></div>
  <div class="nav" id="next-zone"></div>
  <div class="overlay" id="top"><div id="title">Loading…</div><div id="counter">-/-</div></div>
  <div class="overlay" id="bottom">
    <button class="btn" id="prev-btn" aria-label="Prev" disabled><svg viewBox="0 0 24 24"><path d="M15.41 16.59 10.83 12l4.58-4.59L14 6l-6 6 6 6z"/></svg></button>
    <div id="slider-wrap"><input type="range" id="page-slider" min="1" max="1" value="1" disabled /></div>
    <button class="btn" id="next-btn" aria-label="Next" disabled><svg viewBox="0 0 24 24"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg></button>
    <button class="btn" id="fs-btn" aria-label="FS"><svg viewBox="0 0 24 24"><path id="fs-in" d="M7 14H5v5h5v-2H7zm-2-4h2V7h3V5H5zm12 7h-3v2h5v-5h-2zM14 5v2h3v3h2V5z"/><path id="fs-out" d="M5 16h3v3h2v-5H5zm3-11H5v5h2V7h3V5zm6 15h2v-3h3v-2h-5zm2-7h3V5h-2v3h-3z" style="display:none"/></svg></button>
    <button class="btn" id="ep-btn" aria-label="Episodes" disabled><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3zm0 4h2v-2H3zm0-8h2V7H3zm4 4h14v-2H7zm0 4h14v-2H7zm0-10v2h14V7z"/></svg></button>
  </div>
  <div id="spinner"></div>
  <div id="error"><span id="err-text"></span><br><button id="retry">再試行</button></div>
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-box">
      <div class="modal-header"><h2 id="modal-title">エピソード選択</h2><button class="btn" id="modal-close" aria-label="閉じる">×</button></div>
      <div id="ep-list"></div>
    </div>
  </div>
</div>
<script>
/*****************************************************************/
/*                     ❖  Image Pool Class  ❖                     */
/*****************************************************************/
class ImagePool{
  constructor(){this.map=new Map()}
  load(url){
    if(this.map.has(url))return this.map.get(url);
    const img=new Image();img.decoding='async';img.src=url;this.map.set(url,img);return img;
  }
}
/*****************************************************************/
/*                   ❖  Manga Viewer Class  ❖                     */
/*****************************************************************/
class MangaViewer{
  constructor(){
    /*–––––– DOM ––––––*/
    const $=id=>document.getElementById(id);
    this.wrap=$("viewer");this.zoom=$("zoom");this.page=$("page");
    this.top=$("top");this.bottom=$("bottom");this.counter=$("counter");this.title=$("title");
    this.prevBtn=$("prev-btn");this.nextBtn=$("next-btn");
    this.slider=$("page-slider");this.fsBtn=$("fs-btn");this.fsIn=$("fs-in");this.fsOut=$("fs-out");
    this.epBtn=$("ep-btn");
    this.prevZone=$("prev-zone");this.nextZone=$("next-zone");this.centerZone=$("center-zone");
    this.spinner=$("spinner");this.err=$("error");this.errText=$("err-text");this.retryBtn=$("retry");
    this.modal=$("modal");this.epList=$("ep-list");this.modalClose=$("modal-close");

    /*–––––– State ––––––*/
    this.scale=1;this.tx=0;this.ty=0;this.needRender=false;
    this.pageIdx=0;this.total=0;this.pages=[];this.dir='rtl';
    this.containerW=0;this.containerH=0;this.isUI=true;
    this.activePtr=new Map();this.pinchDist0=0;this.scale0=1;
    this.loading=false;this.imagePool=new ImagePool();
    /* Mock data (replace with API) */
    this.mockData={
      id:'manga123',title:'KARMA',reading_direction:'rtl',frontMatter:[{page_number:1,image_url:'i_001.jpg'}],episodes:[{id:'ep1',title:'第1話',pages:[{page_number:2,image_url:'i_002.jpg'},{page_number:3,image_url:'i_003.jpg'}]}]
    };

    this.init();
  }
  /**********  Init  **********/
  init(){
    this.bindUI();this.updateMetrics();this.fetchData();requestAnimationFrame(()=>this.render());
  }
  /**********  Metrics  **********/
  updateMetrics(){const r=this.wrap.getBoundingClientRect();this.containerW=r.width;this.containerH=r.height}
  /**********  RAF Render  **********/
  schedule(){this.needRender=true}
  render(){if(this.needRender){this.zoom.style.transform=`translate3d(${this.tx}px,${this.ty}px,0) scale(${this.scale})`;this.needRender=false}requestAnimationFrame(()=>this.render())}
  /**********  Data  **********/
  async fetchData(){this.spinner.style.display='block';try{
      const d=await new Promise(res=>setTimeout(()=>res(this.mockData),400));
      this.dir=d.reading_direction||'rtl';this.title.textContent=d.title;this.pages=[...d.frontMatter,...d.episodes.flatMap(e=>e.pages)];
      this.total=this.pages.length;this.slider.max=this.total;this.slider.disabled=false;this.epBtn.disabled=false;this.loadPage(0);
    }catch(e){this.showError('データ読み込み失敗');}
    finally{this.spinner.style.display='none'}
  }
  /**********  Page Loading  **********/
  async loadPage(i){if(i<0||i>=this.total||this.loading)return;this.loading=true;this.spinner.style.display='block';
    const url=this.pages[i].image_url;try{
      await this.imagePool.load(url).decode();this.page.src=url;this.page.dataset.url=url;this.pageIdx=i;this.updateCounter();this.preload(i);
    }catch(e){this.showError('画像読み込み失敗');}
    finally{this.loading=false;this.spinner.style.display='none'}
  }
  preload(i){const depth=2;const set=new Set();for(let k=1;k<=depth;k++){let n=(this.dir==='rtl'?i-k:i+k);if(n>=0&&n<this.total)set.add(n);let p=(this.dir==='rtl'?i+k:i-k);if(p>=0&&p<this.total)set.add(p)}
    set.forEach(idx=>{const url=this.pages[idx].image_url;if('requestIdleCallback'in window){requestIdleCallback(()=>this.imagePool.load(url),{timeout:1200})}else{this.imagePool.load(url)}})}
  /**********  Counter & Buttons  **********/
  updateCounter(){this.counter.textContent=`${this.pageIdx+1}/${this.total}`;this.slider.value=this.pageIdx+1;this.prevBtn.disabled=this.pageIdx===0;this.nextBtn.disabled=this.pageIdx===this.total-1;this.prevZone.style.pointerEvents=this.prevBtn.disabled?'none':'auto';this.nextZone.style.pointerEvents=this.nextBtn.disabled?'none':'auto'}
  /**********  Navigation  **********/
  prev(){this.loadPage(this.pageIdx-1)}
  next(){this.loadPage(this.pageIdx+1)}
  goto(i){this.loadPage(i)}
  /**********  UI  **********/
  showUI(){this.wrap.classList.add('show-ui');this.isUI=true;clearTimeout(this.uiTimer);this.uiTimer=setTimeout(()=>this.hideUI(),3000)}
  hideUI(){if(this.modal.classList.contains('active'))return;this.wrap.classList.remove('show-ui');this.isUI=false}
  toggleUI(){this.isUI?this.hideUI():this.showUI()}
  /**********  FS  **********/
  toggleFS(){if(!document.fullscreenElement){document.documentElement.requestFullscreen?.()||document.documentElement.webkitRequestFullscreen?.()}else{document.exitFullscreen?.()||document.webkitExitFullscreen?.()}}
  updateFSIcon(){const fs=!!document.fullscreenElement||!!document.webkitFullscreenElement;this.fsIn.style.display=fs?'none':'block';this.fsOut.style.display=fs?'block':'none';this.fsBtn.setAttribute('aria-label',fs?'Exit full‑screen':'Full‑screen')}
  /**********  Episodes  **********/
  showEp(){this.epList.innerHTML='';let start=0;for(const ep of [{id:'front',title:'表紙',total:this.pages.length}]){const div=document.createElement('div');div.className='ep-item';div.textContent=ep.title;div.dataset.page=start;div.onclick=()=>{this.goto(+div.dataset.page);this.hideEp()};if(this.pageIdx>=start&&this.pageIdx<start+ep.total)div.classList.add('current');this.epList.appendChild(div);start+=ep.total}
    this.modal.classList.add('active');this.modalClose.focus();clearTimeout(this.uiTimer)}
  hideEp(){this.modal.classList.remove('active');this.showUI()}
  /**********  Error  **********/
  showError(msg){this.errText.textContent=msg;this.err.style.display='block'}
  hideError(){this.err.style.display='none'}
  /**********  Events  **********/
  bindUI(){const on=(el,ev,fn,opts)=>el.addEventListener(ev,fn,opts);
    /* Delegated bottom buttons */
    on(this.bottom,'click',e=>{const b=e.target.closest('.btn');if(!b||b.disabled)return;switch(b.id){case'prev-btn':this.prev();break;case'next-btn':this.next();break;case'fs-btn':this.toggleFS();break;case'ep-btn':this.showEp();break}});
    /* Zones */
    on(this.prevZone,'click',()=>this.prev());on(this.nextZone,'click',()=>this.next());on(this.centerZone,'click',()=>this.toggleUI());
    /* Slider */
    on(this.slider,'input',()=>{this.counter.textContent=`${this.slider.value}/${this.total}`;this.showUI();clearTimeout(this.uiTimer)});
    on(this.slider,'change',()=>this.goto(this.slider.value-1));
    /* Retry */
    on(this.retryBtn,'click',()=>{this.hideError();this.loadPage(this.pageIdx)});
    /* Modal */
    on(this.modalClose,'click',()=>this.hideEp());on(this.modal,'click',e=>{if(e.target===this.modal)this.hideEp()});
    /* Resize */
    on(window,'resize',()=>{this.updateMetrics();this.resetZoom()});
    /* FS */
    on(document,'fullscreenchange',()=>this.updateFSIcon());on(document,'webkitfullscreenchange',()=>this.updateFSIcon());
    /* Keyboard */
    on(document,'keydown',e=>{if(['INPUT','TEXTAREA'].includes(e.target.tagName))return;switch(e.key){case'ArrowLeft':case'PageUp':this.prev();break;case'ArrowRight':case'PageDown':this.next();break;case'f':case'F11':this.toggleFS();break;case' ':this.next();break;case'Home':this.goto(0);break;case'End':this.goto(this.total-1);break;case'Escape':if(this.modal.classList.contains('active')){this.hideEp()}else{this.toggleUI()}break}});
    /* Pointer */
    const opts={passive:false};on(this.wrap,'pointerdown',e=>this.ptrDown(e),opts);on(this.wrap,'pointermove',e=>this.ptrMove(e),opts);on(this.wrap,'pointerup',e=>this.ptrEnd(e));on(this.wrap,'pointercancel',e=>this.ptrEnd(e));
  }
  /**********  Pointer Logic  **********/
  ptrDown(e){if(e.button!==0)return;this.activePtr.set(e.pointerId,{x:e.clientX,y:e.clientY});e.target.setPointerCapture(e.pointerId);this.touchX0=e.clientX;this.touchY0=e.clientY;this.panX0=this.tx;this.panY0=this.ty;this.showUI();}
  ptrMove(e){if(!this.activePtr.has(e.pointerId))return;this.activePtr.set(e.pointerId,{x:e.clientX,y:e.clientY});if(this.activePtr.size===2){e.preventDefault();const pts=[...this.activePtr.values()];const dist=Math.hypot(pts[1].x-pts[0].x,pts[1].y-pts[0].y);if(!this.pinchDist0){this.pinchDist0=dist;this.scale0=this.scale;const rect=this.wrap.getBoundingClientRect();this.cx=((pts[0].x+pts[1].x)/2)-rect.left;this.cy=((pts[0].y+pts[1].y)/2)-rect.top}
      const sf=dist/this.pinchDist0;this.scale=Math.min(5,Math.max(1,this.scale0*sf));const dS=this.scale-this.scale0;const ox=(this.cx-this.tx)/this.scale0;const oy=(this.cy-this.ty)/this.scale0;this.tx-=ox*dS;this.ty-=oy*dS;this.bound();this.schedule();}
    else if(this.activePtr.size===1&&this.scale>1){e.preventDefault();const dx=e.clientX-this.touchX0;const dy=e.clientY-this.touchY0;this.tx=this.panX0+dx;this.ty=this.panY0+dy;this.bound();this.schedule();}}
  ptrEnd(e){if(!this.activePtr.has(e.pointerId))return;this.activePtr.delete(e.pointerId);e.target.releasePointerCapture(e.pointerId);this.pinchDist0=0;this.bound();if(this.activePtr.size===0){this.schedule();this.hideUI();}}
  /**********  Helpers  **********/
  bound(){if(this.scale<=1){this.tx=this.ty=0;return;}const maxX=(this.containerW*this.scale-this.containerW)/2;const maxY=(this.containerH*this.scale-this.containerH)/2;this.tx=Math.max(-maxX,Math.min(maxX,this.tx));this.ty=Math.max(-maxY,Math.min(maxY,this.ty));}
  resetZoom(){this.scale=1;this.tx=this.ty=0;this.schedule()}
}
/*****************************************************************/
/*                         ❖  Boot  ❖                           */
/*****************************************************************/
window.addEventListener('DOMContentLoaded',()=>{window.viewer||(window.viewer=new MangaViewer())});
</script>
</body>
</html>
